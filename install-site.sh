#!/bin/bash

# ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐ°Ð¹Ñ‚Ð° Smile Rental
echo "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ ÑÐ°Ð¹Ñ‚Ð° Smile Rental..."

# ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð¿Ð°Ð¿ÐºÑƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
cd /var/www/smilerentalphuket.com/site-smile-rental/smile-rental-modern

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."
sudo npm install

# Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚
echo "ðŸ”¨ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚..."
sudo npm run build

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Nginx
echo "âš™ï¸ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Nginx..."
sudo tee /etc/nginx/sites-available/smile-rental > /dev/null <<EOF
server {
    listen 80;
    server_name smilerentalphuket.com www.smilerentalphuket.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
    }
}
EOF

# ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
sudo ln -sf /etc/nginx/sites-available/smile-rental /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Nginx
sudo nginx -t

# ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Nginx
sudo systemctl restart nginx

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ PM2
sudo tee /var/www/smilerentalphuket.com/site-smile-rental/smile-rental-modern/ecosystem.config.js > /dev/null <<EOF
module.exports = {
  apps: [{
    name: 'smile-rental',
    script: 'npm',
    args: 'start',
    cwd: '/var/www/smilerentalphuket.com/site-smile-rental/smile-rental-modern',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    }
  }]
}
EOF

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· PM2
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐ°Ð¹Ñ‚..."
cd /var/www/smilerentalphuket.com/site-smile-rental/smile-rental-modern
sudo pm2 start ecosystem.config.js
sudo pm2 save
sudo pm2 startup

echo "âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo "ðŸŒ Ð¡Ð°Ð¹Ñ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: http://smilerentalphuket.com"
echo ""
echo "ðŸ“‹ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
echo "   ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ: sudo pm2 status"
echo "   ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð»Ð¾Ð³Ð¸: sudo pm2 logs smile-rental"
echo "   ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ: sudo pm2 restart smile-rental"
