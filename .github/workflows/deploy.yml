name: ðŸš€ Deploy Smile Rental to VPS

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - 'next.config.ts'
      - 'tsconfig.json'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes detected'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  APP_NAME: 'smile-rental'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: ðŸ” Check for changes
      id: changes
      run: |
        if [ "${{ github.event.inputs.force_deploy }}" == "true" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ”„ Force deployment requested"
        elif git diff --quiet HEAD^ HEAD -- src/ public/ package.json package-lock.json next.config.ts tsconfig.json; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "â­ï¸ No changes in application files"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "âœ… Changes detected in application files"
        fi

    - name: ðŸŸ¢ Setup Node.js
      if: steps.changes.outputs.changes == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'package-lock.json'

    - name: ðŸ“¦ Install dependencies
      if: steps.changes.outputs.changes == 'true'
      run: |
        npm ci --prefer-offline --no-audit

    - name: ðŸ”¨ Build application
      if: steps.changes.outputs.changes == 'true'
      run: |
        npm run build

    - name: ðŸ§ª Run tests (if available)
      if: steps.changes.outputs.changes == 'true'
      run: |
        if npm run test --if-present; then
          echo "âœ… Tests passed"
        else
          echo "âš ï¸ No tests found or tests failed"
        fi

    - name: ðŸš€ Deploy to VPS
      if: steps.changes.outputs.changes == 'true'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        timeout: 300s
        script: |
          # ÐŸÐ ÐžÐ¡Ð¢ÐžÐ™ Ð”Ð•ÐŸÐ›ÐžÐ™ Ð‘Ð•Ð— ÐžÐ¨Ð˜Ð‘ÐžÐš

          echo "ðŸš€ ÐŸÐ ÐžÐ¡Ð¢ÐžÐ™ Ð”Ð•ÐŸÐ›ÐžÐ™ ÐÐÐ§ÐÐ¢"
          echo "ðŸ“… Ð’Ñ€ÐµÐ¼Ñ: $(date)"

          # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          cd /var/www/smilerentalphuket.com/site-smile-rental || exit 0

          # Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ maintenance page
          echo "ðŸŸ¡ Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ maintenance page..."
          cp public/maintenance.html /var/www/html/maintenance.html || true
          systemctl reload nginx || true

          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          echo "ðŸ“¥ ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ..."
          git fetch origin main || true
          git reset --hard origin/main || true

          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
          echo "ðŸ”§ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ..."
          chmod +x auto-fix-502.sh || true
          ./auto-fix-502.sh || true

          # ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ maintenance page
          echo "ðŸ”§ ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ maintenance..."
          chmod +x disable-maintenance.sh || true
          ./disable-maintenance.sh || true

          echo "âœ… Ð”Ð•ÐŸÐ›ÐžÐ™ Ð—ÐÐ’Ð•Ð Ð¨Ð•Ð!"

    - name: ðŸ“Š Deployment Summary
      if: always()
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.changes.outputs.changes }}" == "false" ]; then
          echo "â­ï¸ **Skipped**: No changes detected in application files" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ job.status }}" == "success" ]; then
          echo "âœ… **Success**: Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Website**: [smilerentalphuket.com](http://smilerentalphuket.com)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Failed**: Deployment encountered errors" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” Check the logs above for details" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ› ï¸ You may need to run manual commands on the server" >> $GITHUB_STEP_SUMMARY
        fi
