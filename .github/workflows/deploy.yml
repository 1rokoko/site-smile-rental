name: ðŸš€ Deploy Smile Rental to VPS

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - 'next.config.ts'
      - 'tsconfig.json'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes detected'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  APP_NAME: 'smile-rental'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: ðŸ” Check for changes
      id: changes
      run: |
        if [ "${{ github.event.inputs.force_deploy }}" == "true" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ”„ Force deployment requested"
        elif git diff --quiet HEAD^ HEAD -- src/ public/ package.json package-lock.json next.config.ts tsconfig.json; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "â­ï¸ No changes in application files"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "âœ… Changes detected in application files"
        fi

    - name: ðŸŸ¢ Setup Node.js
      if: steps.changes.outputs.changes == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'package-lock.json'

    - name: ðŸ“¦ Install dependencies
      if: steps.changes.outputs.changes == 'true'
      run: |
        npm ci --prefer-offline --no-audit

    - name: ðŸ”¨ Build application
      if: steps.changes.outputs.changes == 'true'
      run: |
        npm run build

    - name: ðŸ§ª Run tests (if available)
      if: steps.changes.outputs.changes == 'true'
      run: |
        if npm run test --if-present; then
          echo "âœ… Tests passed"
        else
          echo "âš ï¸ No tests found or tests failed"
        fi

    - name: ðŸš€ Deploy to VPS
      if: steps.changes.outputs.changes == 'true'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 38.180.122.239
        username: root
        password: 925LudK9Bv
        port: 22
        timeout: 300s
        script: |
          set -e  # Exit on any error

          echo "ðŸš€ Starting deployment to Smile Rental VPS..."
          echo "ðŸ“… Deployment time: $(date)"
          echo "ðŸ”— Commit: ${{ github.sha }}"

          # Navigate to project directory
          cd /var/www/smilerentalphuket.com/site-smile-rental

          # Emergency cleanup: Remove any stuck maintenance pages first
          echo "ðŸ§¹ Emergency cleanup: removing any stuck maintenance pages..."
          rm -f /var/www/html/maintenance.html || true
          rm -f /var/www/smilerentalphuket.com/maintenance.html || true
          nginx -t && systemctl reload nginx || true
          sleep 2

          # Enable maintenance page (no 502 for users)
          echo "ðŸŸ¡ Enabling maintenance page..."
          cp public/maintenance.html /var/www/html/maintenance.html || true
          nginx -t && systemctl reload nginx || true

          # Stop current application to avoid conflicts
          echo "â¹ï¸ Stopping current application..."
          pm2 stop ${{ env.APP_NAME }} || echo "App was not running"
          pm2 delete ${{ env.APP_NAME }} || echo "App was not in PM2"

          # Backup current version (just in case)
          echo "ðŸ’¾ Creating backup..."
          cp -r .next .next.backup.$(date +%Y%m%d_%H%M%S) 2>/dev/null || echo "âš ï¸ No .next directory to backup"

          # Pull latest changes
          echo "ðŸ“¥ Pulling latest changes from GitHub..."
          git fetch origin main
          git reset --hard origin/main

          # Fix Next.js configuration for server mode
          echo "ðŸ”§ Fixing Next.js configuration..."
          if grep -q "output: 'export'" next.config.ts; then
            echo "âš ï¸ Found 'output: export' in next.config.ts, removing it..."
            sed -i "/output: 'export'/d" next.config.ts
            echo "âœ… Next.js configuration fixed for server mode"
          else
            echo "âœ… Next.js configuration is already correct"
          fi

          # EMERGENCY: Complete cleanup to fix corrupted build
          echo "ðŸš¨ EMERGENCY: Complete cleanup to fix corrupted build..."
          rm -rf .next
          rm -rf out
          rm -rf node_modules
          rm -rf .npm
          rm -rf package-lock.json
          npm cache clean --force
          sync
          echo 3 > /proc/sys/vm/drop_caches || true

          # Install dependencies
          echo "ðŸ“¦ Installing dependencies..."
          npm ci --production=false

          # Build the application
          echo "ðŸ”¨ Building application..."
          npm run build

          # Verify build
          echo "âœ… Verifying build..."
          if [ ! -f ".next/BUILD_ID" ]; then
            echo "âŒ Build failed - no BUILD_ID found"
            exit 1
          fi
          echo "âœ… Build verification successful"

          # Apply performance optimizations
          echo "âš¡ Applying performance optimizations..."
          cd smile-rental-modern
          chmod +x *.sh || echo "No optimization scripts found"

          # Run fix deployment script
          echo "ðŸ”§ Running deployment fix..."
          chmod +x fix-deployment.sh
          ./fix-deployment.sh

          # Create optimized PM2 ecosystem config if it doesn't exist
          if [ ! -f "ecosystem.config.js" ]; then
            echo "ðŸ“ Creating optimized PM2 configuration..."
            cat > ecosystem.config.js << 'EOFPM2'
          module.exports = {
            apps: [{
              name: 'smile-rental',
              script: 'npm',
              args: 'start',
              cwd: '/var/www/smilerentalphuket.com/site-smile-rental/smile-rental-modern',
              instances: 'max',
              exec_mode: 'cluster',
              max_memory_restart: '512M',
              node_args: '--max-old-space-size=512',
              autorestart: true,
              watch: false,
              max_restarts: 10,
              min_uptime: '10s',
              env: {
                NODE_ENV: 'production',
                PORT: 3000,
                NODE_OPTIONS: '--max-old-space-size=512'
              }
            }]
          };
          EOFPM2
          fi

          # Start application with optimized PM2 configuration
          echo "ðŸš€ Starting application with PM2 cluster mode..."
          pm2 start ecosystem.config.js

          # Save PM2 configuration
          pm2 save

          # Wait for application to start
          echo "â³ Waiting for application to start..."
          sleep 10

          # Health checks
          echo "ðŸ§ª Running health checks..."

          # Check if app is responding on localhost
          for i in {1..5}; do
            if curl -f -s http://localhost:3000 > /dev/null; then
              echo "âœ… Application is responding on localhost:3000"
              break
            else
              echo "â³ Attempt $i/5: Application not ready yet, waiting..."
              sleep 5
            fi
            if [ $i -eq 5 ]; then
              echo "âŒ Application failed to start on localhost:3000"
              echo "ðŸ“‹ PM2 status:"
              pm2 status
              echo "ðŸ“‹ Application logs:"
              pm2 logs ${{ env.APP_NAME }} --lines 20
              exit 1
            fi
          done

          # Check domain accessibility
          if curl -f -s http://smilerentalphuket.com > /dev/null; then
            echo "âœ… Domain smilerentalphuket.com is accessible"
          else
            echo "âš ï¸ Domain may have Nginx issues, but application is running"
            echo "ðŸ’¡ Run: sudo ./fix-nginx-and-deploy.sh to fix domain issues"
          fi

          # NUCLEAR MAINTENANCE CLEANUP - Stop nginx, find ALL maintenance files, delete them
          echo "ðŸŸ¢ NUCLEAR MAINTENANCE CLEANUP - Stopping nginx and removing ALL maintenance files..."
          systemctl stop nginx || true
          sleep 2

          # Find and delete ALL maintenance.html files on the entire server
          echo "ðŸ” Searching for ALL maintenance.html files on server..."
          find / -name "maintenance.html" -type f 2>/dev/null | while read file; do
            echo "ðŸ—‘ï¸ Deleting: $file"
            rm -f "$file" || true
          done

          # Additional specific cleanup
          rm -f /var/www/html/maintenance.html || true
          rm -f /var/www/smilerentalphuket.com/maintenance.html || true
          rm -f /var/www/smilerentalphuket.com/site-smile-rental/maintenance.html || true
          rm -f /var/www/smilerentalphuket.com/site-smile-rental/public/maintenance.html || true
          rm -f /usr/share/nginx/html/maintenance.html || true
          rm -f /etc/nginx/html/maintenance.html || true

          # Clear nginx cache and restart
          echo "ðŸ”„ Clearing nginx cache and restarting..."
          rm -rf /var/cache/nginx/* || true
          nginx -t && systemctl start nginx || systemctl restart nginx
          sleep 3

          # Comprehensive post-deployment checks
          echo "ðŸ§ª Running post-deployment security and functionality checks..."

          # Check HTTPS redirect
          echo "ðŸ”’ Testing HTTPS redirect..."
          if curl -I http://smilerentalphuket.com 2>/dev/null | grep -q "301\|302"; then
            echo "âœ… HTTP to HTTPS redirect working"
          else
            echo "âš ï¸ HTTP to HTTPS redirect may not be working"
          fi

          # Check HTTPS response
          echo "ðŸ”’ Testing HTTPS response..."
          if curl -fsSL https://smilerentalphuket.com > /dev/null 2>&1; then
            echo "âœ… HTTPS site is accessible"
          else
            echo "âš ï¸ HTTPS site may have issues"
          fi

          # Check security headers
          echo "ðŸ›¡ï¸ Testing security headers..."
          HEADERS=$(curl -I https://smilerentalphuket.com 2>/dev/null || curl -I http://smilerentalphuket.com 2>/dev/null)

          if echo "$HEADERS" | grep -q "Strict-Transport-Security"; then
            echo "âœ… HSTS header present"
          else
            echo "âš ï¸ HSTS header missing"
          fi

          if echo "$HEADERS" | grep -q "Content-Security-Policy"; then
            echo "âœ… CSP header present"
          else
            echo "âš ï¸ CSP header missing"
          fi

          if echo "$HEADERS" | grep -q "X-Frame-Options"; then
            echo "âœ… X-Frame-Options header present"
          else
            echo "âš ï¸ X-Frame-Options header missing"
          fi

          # Check for common vulnerabilities
          echo "ðŸ” Checking for common issues..."
          RESPONSE=$(curl -s https://smilerentalphuket.com || curl -s http://smilerentalphuket.com)

          if echo "$RESPONSE" | grep -qi "error\|exception\|stack trace"; then
            echo "âš ï¸ Potential error messages exposed"
          else
            echo "âœ… No obvious error messages exposed"
          fi

          # Test key pages
          echo "ðŸ“„ Testing key pages..."
          for page in "" "scooter-rental/" "privacy-policy/" "security/"; do
            if curl -f -s "https://smilerentalphuket.com/$page" > /dev/null 2>&1; then
              echo "âœ… Page /$page is accessible"
            else
              echo "âš ï¸ Page /$page may have issues"
            fi
          done

          # Cleanup old backups (keep last 3)
          echo "ðŸ§¹ Cleaning up old backups..."
          ls -t .next.backup.* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || echo "No old backups to clean"

          echo "ðŸŽ‰ Deployment completed successfully!"
          echo "ðŸŒ Website: http://smilerentalphuket.com"
          echo "ðŸ“Š Status: pm2 status"

    - name: ðŸ“Š Deployment Summary
      if: always()
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.changes.outputs.changes }}" == "false" ]; then
          echo "â­ï¸ **Skipped**: No changes detected in application files" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ job.status }}" == "success" ]; then
          echo "âœ… **Success**: Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Website**: [smilerentalphuket.com](http://smilerentalphuket.com)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Failed**: Deployment encountered errors" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” Check the logs above for details" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ› ï¸ You may need to run manual commands on the server" >> $GITHUB_STEP_SUMMARY
        fi
