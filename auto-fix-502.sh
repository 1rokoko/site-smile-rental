#!/bin/bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 502 –æ—à–∏–±–∫–∏

echo "üîß –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 502 –û–®–ò–ë–ö–ò"
echo "========================================"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /var/www/smilerentalphuket.com/site-smile-rental
echo "üìç –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º PM2 –ª–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º PM2 –ª–æ–≥–∏..."
pm2 logs smile-rental --lines 10 || echo "–ù–µ—Ç –ª–æ–≥–æ–≤ PM2"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pm2 delete all || echo "–ù–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"

# –£–±–∏–≤–∞–µ–º –≤—Å–µ Node –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üõë –£–±–∏–≤–∞–µ–º –≤—Å–µ Node –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pkill -f node || echo "–ù–µ—Ç Node –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"

# –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 3000
echo "üîì –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 3000..."
fuser -k 3000/tcp || echo "–ü–æ—Ä—Ç 3000 —Å–≤–æ–±–æ–¥–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º package.json
echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º package.json..."
if [ ! -f "package.json" ]; then
    echo "‚ùå package.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
npm install

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ Next.js —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º Next.js..."
if [ ! -f "node_modules/.bin/next" ]; then
    echo "‚ùå Next.js –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ node_modules!"
    echo "–ü—ã—Ç–∞–µ–º—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Next.js..."
    npm install next
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–±–æ—Ä–∫—É
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–±–æ—Ä–∫—É..."
if [ ! -d ".next" ]; then
    echo "‚ö†Ô∏è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è .next –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –Ω—É–∂–Ω–∞ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞"
fi

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo "üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
npm run build

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–±–æ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
if [ ! -d ".next" ]; then
    echo "‚ùå –°–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å!"
    exit 1
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ PM2 —Å –∞–±—Å–æ–ª—é—Ç–Ω—ã–º –ø—É—Ç–µ–º
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ PM2..."
pm2 start /var/www/smilerentalphuket.com/site-smile-rental/node_modules/.bin/next --name smile-rental -- start -p 3000

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç..."
pm2 status

echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç 3000..."
netstat -tlnp | grep :3000

echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º localhost..."
curl -I http://localhost:3000

# –ü—Ä–æ–≤–µ—Ä—è–µ–º PM2 –ª–æ–≥–∏ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞
echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞..."
pm2 logs smile-rental --lines 5

echo "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
